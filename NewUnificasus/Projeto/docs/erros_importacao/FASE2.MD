 Fase 2: ServiÃ§o de ImportaÃ§Ã£o (90%)

ImportService.cs
ServiÃ§o principal de coordenaÃ§Ã£o

Funcionalidades:

âœ… Descoberta automÃ¡tica de tabelas (busca *_layout.txt)
âœ… OrdenaÃ§Ã£o por prioridade de dependÃªncias
âœ… ImportaÃ§Ã£o sequencial com progresso
âœ… Suporte a cancelamento via CancellationToken
âœ… Reportagem de progresso via IProgress<ImportProgress>
âœ… Tratamento resiliente de erros por linha
âœ… Logging detalhado
MÃ©todos principais:

// Importa todas as tabelas de um diretÃ³rio
Task<List<ImportResult>> ImportAllTablesAsync(
    string sigtapDirectory,
    IProgress<ImportProgress>? progress = null,
    CancellationToken cancellationToken = default)
// Importa uma tabela especÃ­fica
Task<ImportResult> ImportTableAsync(
    ImportTableMetadata metadata,
    string dataFilePath,
    IProgress<ImportProgress>? progress = null,
    CancellationToken cancellationToken = default)
Sistema de Prioridades:

Prioridade 1: Tabelas base (TB_FINANCIAMENTO, TB_RUBRICA, etc.)
Prioridade 2: Estrutura hierÃ¡rquica (TB_GRUPO, TB_CID, etc.)
Prioridade 3: Segundo nÃ­vel (TB_SUB_GRUPO, TB_SERVICO_CLASSIFICACAO)
Prioridade 4: Terceiro nÃ­vel (TB_FORMA_ORGANIZACAO)
Prioridade 5: Procedimentos (TB_PROCEDIMENTO, TB_DESCRICAO)
Prioridade 6: Relacionamentos (RL_*)

ImportConfiguration.cs
ConfiguraÃ§Ãµes de importaÃ§Ã£o

Propriedades:

DefaultEncoding: Encoding padrÃ£o (ISO-8859-1)
BatchSize: Tamanho de lote para inserÃ§Ã£o (1000)
EnableStructureDetection: Detecta mudanÃ§as na estrutura
ImportPriorities: Prioridades customizadas por tabela
RequiredTables: Tabelas obrigatÃ³rias
OptionalTables: Tabelas opcionais
DuplicateMode: Como tratar duplicatas (Ignore/Update/Error)
MaxErrorsBeforeStop: Limite de erros (0 = sem limite)
LogDirectory: DiretÃ³rio para logs
Enums:

public enum DuplicateHandlingMode
{
    Ignore,  // Ignora duplicatas
    Update,  // Atualiza duplicatas
    Error    // Erro ao encontrar duplicata
}
public enum ImportMode
{
    Full,        // Limpa e reimporta tudo
    Incremental, // Apenas novos registros
    NewOnly      // Ignora existentes
}
SerializaÃ§Ã£o JSON:

var config = ImportConfiguration.LoadFromFile("ImportConfiguration.json");
config.SaveToFile("ImportConfiguration.json");

SigtapFileExtractor.cs
UtilitÃ¡rio para manipulaÃ§Ã£o de arquivos

Funcionalidades:

âœ… ExtraÃ§Ã£o de arquivos ZIP
âœ… ValidaÃ§Ã£o de diretÃ³rios SIGTAP
âœ… ObtenÃ§Ã£o de informaÃ§Ãµes (versÃ£o, competÃªncia)
âœ… Limpeza de arquivos temporÃ¡rios
MÃ©todos principais:

// Extrai ZIP para diretÃ³rio
string ExtractZipFile(string zipFilePath, string? targetDirectory = null)
// Verifica se Ã© diretÃ³rio SIGTAP vÃ¡lido
bool IsValidSigtapDirectory(string directory)
// ObtÃ©m informaÃ§Ãµes do arquivo
SigtapFileInfo GetFileInfo(string directoryOrZip)
// Limpa diretÃ³rios temporÃ¡rios
void CleanupTempDirectories()
ValidaÃ§Ã£o:

Verifica presenÃ§a de arquivos *_layout.txt
Verifica presenÃ§a de versao/config.inf/LEIA_ME.TXT

ImportConfiguration.json
Arquivo de configuraÃ§Ã£o padrÃ£o

ContÃ©m:

Prioridades de todas as ~40 tabelas SIGTAP
Tabelas obrigatÃ³rias (4): TB_GRUPO, TB_SUB_GRUPO, TB_FORMA_ORGANIZACAO, TB_PROCEDIMENTO
Tabelas opcionais (8): TB_CID, RL_PROCEDIMENTO_CID, etc.
ConfiguraÃ§Ãµes padrÃ£o
ğŸ“Š Estrutura de Arquivos Atualizada
src/
â”œâ”€â”€ UnificaSUS.Core/Import/
â”‚   â”œâ”€â”€ ImportColumnMetadata.cs      âœ…
â”‚   â”œâ”€â”€ ImportTableMetadata.cs       âœ…
â”‚   â”œâ”€â”€ ImportResult.cs              âœ…
â”‚   â””â”€â”€ ImportProgress.cs            âœ…
â”‚
â”œâ”€â”€ UnificaSUS.Infrastructure/Import/
â”‚   â”œâ”€â”€ LayoutParser.cs               âœ…
â”‚   â”œâ”€â”€ FixedWidthParser.cs           âœ…
â”‚   â”œâ”€â”€ DataValidator.cs              âœ…
â”‚   â”œâ”€â”€ EncodingDetector.cs           âœ…
â”‚   â””â”€â”€ ParserValidationTest.cs       âœ…
â”‚
â””â”€â”€ UnificaSUS.Application/Services/Import/
    â”œâ”€â”€ ImportService.cs               âœ…
    â”œâ”€â”€ ImportConfiguration.cs         âœ…
    â”œâ”€â”€ SigtapFileExtractor.cs         âœ…
    â””â”€â”€ ImportConfiguration.json       âœ…
Total: 13 arquivos criados

ğŸ”„ Fluxo de ImportaÃ§Ã£o Completo
1. UsuÃ¡rio seleciona arquivo ZIP ou pasta
   â†“
2. SigtapFileExtractor valida e extrai (se ZIP)
   â†“
3. ImportService.ImportAllTablesAsync()
   â”œâ”€ Descobre tabelas (LayoutParser)
   â”œâ”€ Ordena por prioridade
   â””â”€ Para cada tabela:
       â”œâ”€ Detecta encoding (EncodingDetector)
       â”œâ”€ LÃª layout (LayoutParser)
       â”œâ”€ Para cada linha:
       â”‚   â”œâ”€ Parse (FixedWidthParser)
       â”‚   â”œâ”€ ValidaÃ§Ã£o (DataValidator)
       â”‚   â”œâ”€ InserÃ§Ã£o no banco âš ï¸ TODO Fase 3
       â”‚   â””â”€ Reporta progresso
       â””â”€ Retorna ImportResult
   â†“
4. Exibe resultados e logs para usuÃ¡rio
âš ï¸ Fase 3 necessÃ¡ria: Implementar ImportRepository para inserÃ§Ã£o no banco

ğŸ¯ CaracterÃ­sticas Implementadas
Requisito	Status
String Vazia	âœ… Tratado
Formato InvÃ¡lido	âœ… Tratado
Caracteres Especiais	âœ… Encoding auto
Tipo IncompatÃ­vel	âœ… ConversÃ£o flexÃ­vel
Novas Tabelas	âœ… Descobre auto
Novas Colunas	âœ… Ignora desconhecidas
MudanÃ§a SequÃªncia	âœ… Usa posiÃ§Ãµes fixas
Cancelamento	âœ… CancellationToken
Progresso	âœ… IProgress
PriorizaÃ§Ã£o	âœ… Sistema completo
ğŸ“ PrÃ³ximos Passos
Fase 3: RepositÃ³rios (PrÃ³xima)
 ImportRepository.cs - InserÃ§Ã£o dinÃ¢mica no banco
 GeraÃ§Ã£o de SQL dinÃ¢mico
 Tratamento de duplicatas (INSERT OR UPDATE)
 Batch insert para performance
Fase 4: Interface de UsuÃ¡rio
 ImportWindow.xaml - Janela dedicada
 Binding de progresso visual
 Logs em tempo real
 Controles (Iniciar/Pausar/Cancelar)
Ãšltima atualizaÃ§Ã£o: 21/11/2025 20:05
Progresso geral: ~40% (Fases 1-2 de 6 concluÃ­das)