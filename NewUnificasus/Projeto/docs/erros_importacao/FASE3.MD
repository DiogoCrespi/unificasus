Walkthrough: ImplementaÃ§Ã£o da Funcionalidade de ImportaÃ§Ã£o SIGTAP
Resumo do Progresso
Status Atual: Fase 3 (RepositÃ³rios) - 100% concluÃ­da | Progresso: ~55%

âœ… Fases ConcluÃ­das
Fase 1: Camada de DomÃ­nio (100%) - 9 arquivos
Fase 2: ServiÃ§o de ImportaÃ§Ã£o (100%) - 4 arquivos
Fase 3: RepositÃ³rios (100%) - 1 arquivo
âœ… Fase 3: RepositÃ³rios (NEW!)

ImportRepository.cs
RepositÃ³rio de importaÃ§Ã£o dinÃ¢mica

Funcionalidades:

âœ… InserÃ§Ã£o/atualizaÃ§Ã£o automÃ¡tica baseada em metadados
âœ… GeraÃ§Ã£o dinÃ¢mica de SQL (INSERT/UPDATE)
âœ… VerificaÃ§Ã£o de duplicatas por chaves primÃ¡rias
âœ… Batch insert para performance (lotes de 1000)
âœ… Tratamento de transaÃ§Ãµes
âœ… Delete por competÃªncia
âœ… Count de registros
MÃ©todos principais:

// Insere ou atualiza registro
Task<bool> InsertOrUpdateAsync(
    string tableName,
    Dictionary<string, object?> data,
    ImportTableMetadata metadata,
    DuplicateHandlingMode duplicateMode,
    CancellationToken cancellationToken)
// Batch insert
Task<int> InsertBatchAsync(
    string tableName,
    List<Dictionary<string, object?>> dataList,
    ImportTableMetadata metadata,
    int batchSize = 1000,
    CancellationToken cancellationToken)
// Delete por competÃªncia
Task<int> DeleteByCompetenciaAsync(
    string tableName,
    string competencia,
    CancellationToken cancellationToken)
GeraÃ§Ã£o DinÃ¢mica de SQL:

// Exemplo de INSERT gerado dinamicamente:
INSERT INTO TB_PROCEDIMENTO (CO_PROCEDIMENTO, NO_PROCEDIMENTO, VL_SA, VL_SH, DT_COMPETENCIA)
VALUES (@CO_PROCEDIMENTO, @NO_PROCEDIMENTO, @VL_SA, @VL_SH, @DT_COMPETENCIA)
// Exemplo de UPDATE gerado:
UPDATE TB_PROCEDIMENTO
SET NO_PROCEDIMENTO = @NO_PROCEDIMENTO, VL_SA = @VL_SA
WHERE CO_PROCEDIMENTO = @PK_CO_PROCEDIMENTO AND DT_COMPETENCIA = @PK_DT_COMPETENCIA
Tratamento de Duplicatas:

DuplicateHandlingMode.Ignore: Ignora registro duplicado
DuplicateHandlingMode.Update: Atualiza registro existente
DuplicateHandlingMode.Error: LanÃ§a exceÃ§Ã£o
ConversÃ£o de Tipos:

NUMBER/NUMERIC â†’ decimal/int/long
VARCHAR2/CHAR â†’ string
DATE â†’ string (formato AAAAMM)
Valores null â†’ DBNull.Value
IntegraÃ§Ã£o com 

ImportService
O 

ImportService
 foi atualizado para usar 

ImportRepository
:

// Construtor aceita repository opcional
public ImportService(ILogger? logger = null, ImportRepository? importRepository = null)
// Durante importaÃ§Ã£o, insere no banco
if (_importRepository != null)
{
    await _importRepository.InsertOrUpdateAsync(
        metadata.TableName,
        data,
        metadata,
        DuplicateHandlingMode.Update,
        cancellationToken);
}
Modo SimulaÃ§Ã£o: Se 

ImportRepository
 for null, funciona sem banco (apenas validaÃ§Ã£o)

ğŸ“Š Arquitetura Completa (Backend)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ImportService (Coordenador Principal)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Descoberta de tabelas                     â”‚
â”‚ - OrdenaÃ§Ã£o por prioridade                  â”‚
â”‚ - Processamento com progresso               â”‚
â”‚ - Cancelamento via CancellationToken        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚          â”‚                  â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚Layout â”‚  â”‚Fixed â”‚  â”‚Data    â”‚  â”‚Encoding        â”‚
â”‚Parser â”‚  â”‚Width â”‚  â”‚Validatorâ”‚  â”‚Detector        â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚Parserâ”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚      â””â”€â”€â”¬â”€â”€â”€â”˜      â”‚
    â”‚         â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
       â”‚   ImportRepository   â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ - SQL dinÃ¢mico      â”‚
       â”‚ - INSERT/UPDATE     â”‚
       â”‚ - Batch processing  â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ FirebirdContext  â”‚
       â”‚ (Banco Firebird) â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ğŸ”„ Fluxo Completo de ImportaÃ§Ã£o
1. UsuÃ¡rio seleciona ZIP/pasta
   â†“
2. SigtapFileExtractor extrai arquivos
   â†“
3. ImportService descobre tabelas (LayoutParser)
   â†“
4. Ordena por prioridade (1-6)
   â†“
5. Para cada tabela:
   â”œâ”€ Detecta encoding
   â”œâ”€ LÃª layout
   â”œâ”€ Para cada linha:
   â”‚   â”œâ”€ Parse (FixedWidthParser)
   â”‚   â”œâ”€ ValidaÃ§Ã£o (DataValidator)
   â”‚   â”œâ”€ ConversÃ£o de tipos
   â”‚   â”œâ”€ INSERT/UPDATE (ImportRepository) âœ… NOVO
   â”‚   â””â”€ Reporta progresso
   â””â”€ Retorna ImportResult
   â†“
6. Exibe resultados
ğŸ“Š Estrutura Completa de Arquivos
Total: 14 arquivos (3 fases backend completas)

src/
â”œâ”€â”€ UnificaSUS.Core/Import/            (4 arquivos)
â”‚   â”œâ”€â”€ ImportColumnMetadata.cs        âœ…
â”‚   â”œâ”€â”€ ImportTableMetadata.cs         âœ…
â”‚   â”œâ”€â”€ ImportResult.cs                âœ…
â”‚   â””â”€â”€ ImportProgress.cs              âœ…
â”‚
â”œâ”€â”€ UnificaSUS.Infrastructure/
â”‚   â”œâ”€â”€ Import/                        (5 arquivos)
â”‚   â”‚   â”œâ”€â”€ LayoutParser.cs            âœ…
â”‚   â”‚   â”œâ”€â”€ FixedWidthParser.cs        âœ…
â”‚   â”‚   â”œâ”€â”€ DataValidator.cs           âœ…
â”‚   â”‚   â”œâ”€â”€ EncodingDetector.cs        âœ…
â”‚   â”‚   â””â”€â”€ ParserValidationTest.cs    âœ…
â”‚   â”‚
â”‚   â””â”€â”€ Repositories/                  (1 arquivo)
â”‚       â””â”€â”€ ImportRepository.cs        âœ… NOVO
â”‚
â””â”€â”€ UnificaSUS.Application/Services/Import/  (4 arquivos)
    â”œâ”€â”€ ImportService.cs               âœ… (atualizado)
    â”œâ”€â”€ ImportConfiguration.cs         âœ…
    â”œâ”€â”€ SigtapFileExtractor.cs         âœ…
    â””â”€â”€ ImportConfiguration.json       âœ…
ğŸ¯ PrÃ³ximos Passos
Fase 4: Interface de UsuÃ¡rio (PrÃ³xima)

 ImportWindow.xaml - Janela WPF dedicada
 ImportWindow.xaml.cs - Code-behind
 Binding de progresso visual
 Logs em tempo real
 Controles (Iniciar/Pausar/Cancelar)
Funcionalidades pendentes:

Fase 5: Detector de mudanÃ§as de estrutura
Fase 6: Sistema de logging e auditoria persistente
Ãšltima atualizaÃ§Ã£o: 21/11/2025 20:12
Progresso geral: ~55% (Fases 1-3 de 6 concluÃ­das - Backend completo!)